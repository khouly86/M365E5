@inject IUserService UserService
@inject ISnackbar Snackbar
@using Cloudativ.Assessment.Application.DTOs
@using Cloudativ.Assessment.Application.Interfaces
@using System.ComponentModel.DataAnnotations

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.LockReset" Color="Color.Warning" Class="mr-2" />
            <MudText Typo="Typo.h6">Reset Password</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Class="mb-4" Style="color: var(--mud-palette-text-secondary);">
            Reset password for <strong>@UserEmail</strong>
        </MudText>

        <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="_model.NewPassword"
                          Label="New Password"
                          Required="true"
                          RequiredError="Password is required"
                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          Adornment="Adornment.End"
                          AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                          OnAdornmentClick="@(() => _showPassword = !_showPassword)" />

            <MudTextField @bind-Value="_model.ConfirmPassword"
                          Label="Confirm Password"
                          Required="true"
                          RequiredError="Please confirm the password"
                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          Adornment="Adornment.End"
                          AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                          OnAdornmentClick="@(() => _showPassword = !_showPassword)" />

            @* Password Requirements *@
            <MudAlert Severity="MudBlazor.Severity.Info" Dense="true" Class="mt-2">
                <MudText Typo="Typo.caption">Password must contain:</MudText>
                <ul style="margin: 4px 0 0 16px; padding: 0;">
                    <li><MudText Typo="Typo.caption">At least 8 characters</MudText></li>
                    <li><MudText Typo="Typo.caption">At least one uppercase letter</MudText></li>
                    <li><MudText Typo="Typo.caption">At least one lowercase letter</MudText></li>
                    <li><MudText Typo="Typo.caption">At least one number</MudText></li>
                    <li><MudText Typo="Typo.caption">At least one special character (@@, $, !, %, *, ?, &amp;)</MudText></li>
                </ul>
            </MudAlert>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="HandleSubmit"
                   Disabled="@_isSubmitting"
                   StartIcon="@(_isSubmitting ? null : Icons.Material.Filled.LockReset)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Resetting...</span>
            }
            else
            {
                <span>Reset Password</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid UserId { get; set; }
    [Parameter] public string UserEmail { get; set; } = string.Empty;

    private ResetPasswordModel _model = new();
    private bool _isSubmitting = false;
    private bool _showPassword = false;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_model.NewPassword))
        {
            Snackbar.Add("Password is required", MudBlazor.Severity.Error);
            return;
        }

        if (_model.NewPassword != _model.ConfirmPassword)
        {
            Snackbar.Add("Passwords do not match", MudBlazor.Severity.Error);
            return;
        }

        // Validate password strength
        if (!IsPasswordValid(_model.NewPassword))
        {
            Snackbar.Add("Password does not meet the requirements", MudBlazor.Severity.Error);
            return;
        }

        _isSubmitting = true;

        try
        {
            var dto = new ResetPasswordDto
            {
                UserId = UserId,
                NewPassword = _model.NewPassword
            };

            await UserService.ResetPasswordAsync(dto);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private bool IsPasswordValid(string password)
    {
        if (string.IsNullOrEmpty(password) || password.Length < 8)
            return false;

        bool hasUpper = password.Any(char.IsUpper);
        bool hasLower = password.Any(char.IsLower);
        bool hasDigit = password.Any(char.IsDigit);
        bool hasSpecial = password.Any(c => "@$!%*?&".Contains(c));

        return hasUpper && hasLower && hasDigit && hasSpecial;
    }

    private void Cancel() => MudDialog.Cancel();

    private class ResetPasswordModel
    {
        [Required(ErrorMessage = "Password is required")]
        [MinLength(8, ErrorMessage = "Password must be at least 8 characters")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm the password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
