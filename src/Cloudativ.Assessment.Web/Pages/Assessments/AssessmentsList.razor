@page "/assessments"
@attribute [Authorize]
@inject IAssessmentService AssessmentService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Assessments - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">Assessment History</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
               OnClick="@(() => NavigationManager.NavigateTo("/assessments/new"))">
        Run Assessment
    </MudButton>
</div>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (!_assessments.Any())
{
    <MudPaper Class="pa-6" Elevation="2" Style="border-radius: 12px;">
        <div class="text-center">
            <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
            <MudText Typo="Typo.h6" Class="mb-2">No Assessments Yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Run your first security assessment to see results here.
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/assessments/new">
                Run Assessment
            </MudButton>
        </div>
    </MudPaper>
}
else
{
    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
        <MudTable Items="@_assessments" Hover="true" Dense="false">
            <HeaderContent>
                <MudTh>Tenant</MudTh>
                <MudTh>Started</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Score</MudTh>
                <MudTh>Duration</MudTh>
                <MudTh>Initiated By</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Tenant">
                    <MudLink Href="@($"/tenants/{context.TenantId}")">@context.TenantName</MudLink>
                </MudTd>
                <MudTd DataLabel="Started">@context.StartedAt.ToString("MMM dd, yyyy HH:mm")</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip Size="Size.Small" Color="@GetStatusColor(context.Status)" Variant="Variant.Filled">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Score">
                    @if (context.OverallScore.HasValue)
                    {
                        <MudChip Size="Size.Small" Style="@($"background: {GetScoreColor(context.OverallScore.Value)}; color: white;")">
                            @context.OverallScore%
                        </MudChip>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </MudTd>
                <MudTd DataLabel="Duration">@(context.Duration?.ToString(@"mm\:ss") ?? "-")</MudTd>
                <MudTd DataLabel="Initiated By">@(context.InitiatedBy ?? "System")</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                   OnClick="@(() => NavigationManager.NavigateTo($"/tenants/{context.TenantId}"))"
                                   Title="View Details" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
}

@code {
    private bool _isLoading = true;
    private List<AssessmentRunDto> _assessments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAssessmentsAsync();
    }

    private async Task LoadAssessmentsAsync()
    {
        _isLoading = true;
        try
        {
            _assessments = (await AssessmentService.GetAllRunsAsync(50)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading assessments: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetStatusColor(AssessmentStatus status) => status switch
    {
        AssessmentStatus.Completed => Color.Success,
        AssessmentStatus.Running => Color.Info,
        AssessmentStatus.Failed => Color.Error,
        AssessmentStatus.Cancelled => Color.Warning,
        AssessmentStatus.Pending => Color.Default,
        _ => Color.Default
    };

    private string GetScoreColor(int score) => score switch
    {
        >= 90 => "#4CAF50",
        >= 80 => "#8BC34A",
        >= 70 => "#FFC107",
        >= 60 => "#FF9800",
        _ => "#f44336"
    };
}
