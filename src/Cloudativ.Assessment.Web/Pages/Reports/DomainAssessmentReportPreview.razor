@inject IAssessmentService AssessmentService

<div class="report-preview">
    <div class="d-flex align-center mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Large" Style="color: #51627A;" Class="mr-3" />
        <div>
            <MudText Typo="Typo.h6">Domain Assessment Report</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @if (Domain.HasValue)
                {
                    <span>Detailed report for @Domain.Value.GetDisplayName()</span>
                }
                else
                {
                    <span>Assessment results across all security domains</span>
                }
            </MudText>
        </div>
    </div>

    <MudDivider Class="mb-4" />

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (_assessment != null)
    {
        <MudText Typo="Typo.subtitle1" Class="mb-3">Domain Scores</MudText>

        <MudGrid Spacing="2">
            @foreach (var domain in GetFilteredDomains())
            {
                <MudItem xs="6" md="4">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@domain.Value.DisplayName</MudText>
                        <div class="d-flex align-center justify-space-between">
                            <MudText Typo="Typo.h5" Style="@($"font-weight: 600; color: {GetScoreColor(domain.Value.Score)}")">
                                @domain.Value.Score%
                            </MudText>
                            <MudChip Size="Size.Small" Style="@($"background: {GetScoreColor(domain.Value.Score)}; color: white;")">
                                @domain.Value.Grade
                            </MudChip>
                        </div>
                        <MudProgressLinear Value="@domain.Value.Score" Color="@GetProgressColor(domain.Value.Score)"
                                           Size="Size.Small" Class="mt-2" />
                        <div class="d-flex justify-space-between mt-1">
                            <MudText Typo="Typo.caption" Style="color: #DC2626;">@domain.Value.CriticalCount C</MudText>
                            <MudText Typo="Typo.caption" Style="color: #EA580C;">@domain.Value.HighCount H</MudText>
                            <MudText Typo="Typo.caption" Style="color: #CA8A04;">@domain.Value.MediumCount M</MudText>
                            <MudText Typo="Typo.caption" Style="color: #16A34A;">@domain.Value.LowCount L</MudText>
                        </div>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>

        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Report Includes:</MudText>
        <MudList T="string" Dense="true">
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Domain score and grade</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Findings breakdown by severity</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Detailed finding descriptions</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Remediation guidance</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Key metrics and configurations</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Best practice recommendations</MudListItem>
        </MudList>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            Select an assessment to see domain scores.
        </MudAlert>
    }
</div>

@code {
    [Parameter] public Guid? AssessmentId { get; set; }
    [Parameter] public AssessmentDomain? Domain { get; set; }

    private AssessmentRunDto? _assessment;
    private bool _isLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadAssessmentAsync();
    }

    private async Task LoadAssessmentAsync()
    {
        if (!AssessmentId.HasValue) return;

        _isLoading = true;
        try
        {
            _assessment = await AssessmentService.GetRunByIdAsync(AssessmentId.Value);
        }
        catch
        {
            _assessment = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private IEnumerable<KeyValuePair<string, DomainScoreSummary>> GetFilteredDomains()
    {
        if (_assessment == null) return Enumerable.Empty<KeyValuePair<string, DomainScoreSummary>>();

        if (Domain.HasValue)
        {
            return _assessment.DomainScores.Where(d => d.Key == Domain.Value.ToString());
        }
        return _assessment.DomainScores.OrderByDescending(d => d.Value.CriticalCount + d.Value.HighCount);
    }

    private string GetScoreColor(int score) => score switch
    {
        >= 90 => "#16A34A",
        >= 80 => "#22C55E",
        >= 70 => "#CA8A04",
        >= 60 => "#EA580C",
        _ => "#DC2626"
    };

    private Color GetProgressColor(int score) => score switch
    {
        >= 80 => Color.Success,
        >= 60 => Color.Warning,
        _ => Color.Error
    };
}
