@inject IDashboardService DashboardService

<div class="report-preview">
    <div class="d-flex align-center mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Large" Style="color: #51627A;" Class="mr-3" />
        <div>
            <MudText Typo="Typo.h6">M365 Resources Report</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Overview of all Microsoft 365 resources across your tenant
            </MudText>
        </div>
    </div>

    <MudDivider Class="mb-4" />

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (_resourceStats != null && _resourceStats.TotalUsers > 0)
    {
        <MudText Typo="Typo.subtitle1" Class="mb-3">Report Preview</MudText>

        <MudGrid Spacing="2">
            <MudItem xs="6" md="4">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Users</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 600;">@_resourceStats.TotalUsers.ToString("N0")</MudText>
                    <MudText Typo="Typo.caption">@_resourceStats.GuestUsers.ToString("N0") guests</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="4">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Admins</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #EF7348;">@_resourceStats.AdminUsers</MudText>
                    <MudText Typo="Typo.caption">@_resourceStats.GlobalAdmins Global Admins</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="4">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Devices</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 600;">@_resourceStats.TotalDevices.ToString("N0")</MudText>
                    <MudText Typo="Typo.caption">@_resourceStats.ManagedDevices.ToString("N0") managed</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="4">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Apps</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #9C27B0;">@_resourceStats.EnterpriseApps.ToString("N0")</MudText>
                    <MudText Typo="Typo.caption">@_resourceStats.AppRegistrations.ToString("N0") registrations</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="4">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Groups</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #3F51B5;">@_resourceStats.TotalGroups.ToString("N0")</MudText>
                    <MudText Typo="Typo.caption">@_resourceStats.Microsoft365Groups.ToString("N0") M365 groups</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" md="4">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Mailboxes</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #0078D4;">@_resourceStats.Mailboxes.ToString("N0")</MudText>
                    <MudText Typo="Typo.caption">@_resourceStats.SharedMailboxes.ToString("N0") shared</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Report Includes:</MudText>
        <MudList T="string" Dense="true">
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Identity & Access statistics (users, admins, guests)</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Groups breakdown (security, M365)</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Application inventory (enterprise apps, registrations)</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Device & endpoint statistics</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Policy counts (CA policies, DLP)</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Collaboration resources (mailboxes, SharePoint, Teams)</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">License utilization</MudListItem>
        </MudList>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            Select a tenant and run an assessment to see resource statistics.
        </MudAlert>
    }
</div>

@code {
    [Parameter] public Guid? TenantId { get; set; }

    private ResourceStatisticsDto? _resourceStats;
    private bool _isLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadResourceStatsAsync();
    }

    private async Task LoadResourceStatsAsync()
    {
        _isLoading = true;
        try
        {
            if (TenantId.HasValue)
            {
                _resourceStats = await DashboardService.GetResourceStatisticsAsync(TenantId.Value);
            }
            else
            {
                _resourceStats = await DashboardService.GetAggregatedResourceStatisticsAsync();
            }
        }
        catch
        {
            _resourceStats = null;
        }
        finally
        {
            _isLoading = false;
        }
    }
}
