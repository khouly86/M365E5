@inject IAssessmentService AssessmentService

<div class="report-preview">
    <div class="d-flex align-center mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" Style="color: #EA580C;" Class="mr-3" />
        <div>
            <MudText Typo="Typo.h6">Impacted Resources Report</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Detailed list of resources affected by security findings
            </MudText>
        </div>
    </div>

    <MudDivider Class="mb-4" />

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (_findings.Any())
    {
        <MudText Typo="Typo.subtitle1" Class="mb-3">Findings with Impacted Resources</MudText>

        <MudSimpleTable Dense="true" Hover="true" Style="max-height: 300px; overflow-y: auto;">
            <thead>
                <tr>
                    <th>Severity</th>
                    <th>Finding</th>
                    <th>Impacted Resources</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var finding in _findings.Where(f => f.AffectedResources.Any()).Take(10))
                {
                    <tr>
                        <td>
                            <MudChip Size="Size.Small" Color="@GetSeverityColor(finding.Severity)" Variant="Variant.Filled">
                                @finding.Severity
                            </MudChip>
                        </td>
                        <td>@finding.Title</td>
                        <td>
                            <MudText Typo="Typo.body2">@finding.AffectedResources.Count resources</MudText>
                        </td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>

        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Report Includes:</MudText>
        <MudList T="string" Dense="true">
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Full list of impacted users, groups, and devices</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Resource details (names, IDs, types)</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Associated security findings</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Severity classification per resource</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.Check" IconColor="Color.Success">Remediation recommendations</MudListItem>
        </MudList>

        <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
            Total: @_findings.Sum(f => f.AffectedResources.Count) impacted resources across @_findings.Count(f => f.AffectedResources.Any()) findings
        </MudAlert>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            Select an assessment to see impacted resources.
        </MudAlert>
    }
</div>

@code {
    [Parameter] public Guid? AssessmentId { get; set; }

    private List<FindingDto> _findings = new();
    private bool _isLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadFindingsAsync();
    }

    private async Task LoadFindingsAsync()
    {
        if (!AssessmentId.HasValue) return;

        _isLoading = true;
        try
        {
            _findings = (await AssessmentService.GetFindingsAsync(AssessmentId.Value, null, null)).ToList();
        }
        catch
        {
            _findings = new();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetSeverityColor(DomainSeverity severity) => severity switch
    {
        DomainSeverity.Critical => Color.Error,
        DomainSeverity.High => Color.Warning,
        DomainSeverity.Medium => Color.Info,
        _ => Color.Default
    };
}
