@page "/tenants/{TenantId:guid}"
@attribute [Authorize]
@inject ITenantService TenantService
@inject IDashboardService DashboardService
@inject IAssessmentService AssessmentService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>@(_tenant?.Name ?? "Tenant") - Cloudativ Assessment</PageTitle>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_tenant == null)
{
    <MudAlert Severity="Severity.Error">Tenant not found</MudAlert>
}
else
{
    <!-- Header -->
    <div class="d-flex justify-space-between align-center mb-4">
        <div class="d-flex align-center">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => NavigationManager.NavigateTo("/tenants"))" />
            <div class="ml-2">
                <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">@_tenant.Name</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@_tenant.Domain</MudText>
            </div>
        </div>
        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit"
                       OnClick="EditTenant">
                Edit
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Compare"
                       OnClick="CompareAssessments" Disabled="@(_tenant.TotalAssessments < 2)">
                Compare
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PlayArrow"
                       OnClick="StartAssessment" Disabled="@(_tenant.OnboardingStatus != OnboardingStatus.Active && _tenant.OnboardingStatus != OnboardingStatus.Validated)">
                Run Assessment
            </MudButton>
        </div>
    </div>

    <!-- Status Banner -->
    @if (_tenant.OnboardingStatus != OnboardingStatus.Active && _tenant.OnboardingStatus != OnboardingStatus.Validated)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <div class="d-flex justify-space-between align-center">
                <span>This tenant requires configuration before running assessments.</span>
                <MudButton Variant="Variant.Text" Color="Color.Warning" OnClick="@(() => NavigationManager.NavigateTo($"/tenants/{TenantId}/onboarding"))">
                    Complete Setup
                </MudButton>
            </div>
        </MudAlert>
    }

    <MudGrid>
        <!-- Overview Cards -->
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Overall Score</MudText>
                @if (_dashboard.LatestAssessment?.OverallScore.HasValue == true)
                {
                    <MudText Typo="Typo.h3" Style="@($"font-weight: 600; color: {GetScoreColor(_dashboard.LatestAssessment.OverallScore.Value)}")">
                        @_dashboard.LatestAssessment.OverallScore%
                    </MudText>
                    <MudChip Size="Size.Small" Style="@($"background: {GetScoreColor(_dashboard.LatestAssessment.OverallScore.Value)}; color: white;")">
                        Grade @GetGrade(_dashboard.LatestAssessment.OverallScore.Value)
                    </MudChip>
                }
                else
                {
                    <MudText Typo="Typo.h3" Color="Color.Secondary">N/A</MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Total Assessments</MudText>
                <MudText Typo="Typo.h3" Style="font-weight: 600;">@_tenant.TotalAssessments</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Critical Findings</MudText>
                <MudText Typo="Typo.h3" Style="font-weight: 600; color: #f44336;">
                    @_dashboard.FindingsSummary.CriticalCount
                </MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Last Assessment</MudText>
                @if (_tenant.LastAssessmentDate.HasValue)
                {
                    <MudText Typo="Typo.h6" Style="font-weight: 500;">
                        @_tenant.LastAssessmentDate.Value.ToString("MMM dd, yyyy")
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @GetTimeAgo(_tenant.LastAssessmentDate.Value)
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.h6" Color="Color.Secondary">Never</MudText>
                }
            </MudPaper>
        </MudItem>

        <!-- M365 Resources Overview -->
        @if (_resourceStats != null && _resourceStats.TotalUsers > 0)
        {
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                    <MudText Typo="Typo.h6" Class="mb-4">M365 Resources</MudText>
                    <MudGrid Spacing="2">
                        <!-- Users -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.People" Style="color: #51627A;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.TotalUsers.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Users</MudText>
                            </div>
                        </MudItem>

                        <!-- Guests -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Style="color: #2196F3;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.GuestUsers.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Guests</MudText>
                            </div>
                        </MudItem>

                        <!-- Admins -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Style="color: #EF7348;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.AdminUsers</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Admins (@_resourceStats.GlobalAdmins GA)</MudText>
                            </div>
                        </MudItem>

                        <!-- Apps -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Apps" Style="color: #9C27B0;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.EnterpriseApps.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Enterprise Apps</MudText>
                            </div>
                        </MudItem>

                        <!-- Devices -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Devices" Style="color: #00BCD4;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.TotalDevices.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Devices</MudText>
                            </div>
                        </MudItem>

                        <!-- CA Policies -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Policy" Style="color: #FF9800;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.ConditionalAccessPolicies</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">CA Policies (@_resourceStats.EnabledCaPolicies enabled)</MudText>
                            </div>
                        </MudItem>

                        <!-- Groups -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Groups" Style="color: #3F51B5;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.TotalGroups.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Groups</MudText>
                            </div>
                        </MudItem>

                        <!-- Mailboxes -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Email" Style="color: #0078D4;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.Mailboxes.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Mailboxes</MudText>
                            </div>
                        </MudItem>

                        <!-- SharePoint Sites -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Folder" Style="color: #038387;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.SharePointSites.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">SharePoint Sites</MudText>
                            </div>
                        </MudItem>

                        <!-- Teams -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.Group" Style="color: #6264A7;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.TeamsCount.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Teams</MudText>
                            </div>
                        </MudItem>

                        <!-- App Registrations -->
                        <MudItem xs="6" sm="4" md="2">
                            <div class="resource-stat-card">
                                <MudIcon Icon="@Icons.Material.Filled.AppRegistration" Style="color: #673AB7;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@_resourceStats.AppRegistrations.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">App Registrations</MudText>
                            </div>
                        </MudItem>

                        <!-- Risky Users -->
                        @if (_resourceStats.RiskyUsers > 0)
                        {
                            <MudItem xs="6" sm="4" md="2">
                                <div class="resource-stat-card" style="border-color: #f44336;">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Style="color: #f44336;" />
                                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #f44336;">@_resourceStats.RiskyUsers</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Risky Users</MudText>
                                </div>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            </MudItem>
        }

        <!-- Score Trend Chart -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mb-4">Score Trend</MudText>
                @if (_dashboard.ScoreTrend.Any())
                {
                    <MudChart ChartType="ChartType.Line"
                              ChartSeries="@_scoreTrendSeries"
                              XAxisLabels="@_scoreTrendLabels"
                              Width="100%"
                              Height="300px"
                              ChartOptions="@_chartOptions" />
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-8">
                        No assessment history available
                    </MudText>
                }
            </MudPaper>
        </MudItem>

        <!-- Domain Scores -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mb-4">Domain Scores</MudText>
                @if (_dashboard.DomainBreakdown.Any())
                {
                    <MudList Dense="true">
                        @foreach (var domain in _dashboard.DomainBreakdown.OrderByDescending(d => d.Value.Score))
                        {
                            <MudListItem>
                                <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                    <MudText Typo="Typo.body2">@domain.Value.DisplayName</MudText>
                                    <MudChip Size="Size.Small" Style="@($"background: {GetScoreColor(domain.Value.Score)}; color: white;")">
                                        @domain.Value.Score%
                                    </MudChip>
                                </div>
                                <MudProgressLinear Value="@domain.Value.Score" Color="@GetProgressColor(domain.Value.Score)"
                                                   Class="mt-1" Size="Size.Small" />
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                        Run an assessment to see domain scores
                    </MudText>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Findings -->
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6">Critical & High Findings</MudText>
                    @if (_dashboard.LatestAssessment != null)
                    {
                        <MudButton Variant="Variant.Text" Color="Color.Primary"
                                   OnClick="@(() => NavigationManager.NavigateTo($"/assessments/{_dashboard.LatestAssessment.Id}"))">
                            View All Findings
                        </MudButton>
                    }
                </div>

                @if (_dashboard.FindingsSummary.TopCriticalFindings.Any())
                {
                    <MudTable Items="@_dashboard.FindingsSummary.TopCriticalFindings" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>Severity</MudTh>
                            <MudTh>Domain</MudTh>
                            <MudTh>Title</MudTh>
                            <MudTh>Description</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudChip Size="Size.Small" Color="@GetSeverityColor(context.Severity)" Variant="Variant.Filled">
                                    @context.Severity
                                </MudChip>
                            </MudTd>
                            <MudTd>@context.DomainDisplayName</MudTd>
                            <MudTd>@context.Title</MudTd>
                            <MudTd Style="max-width: 400px;">
                                <MudText Typo="Typo.body2" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @context.Description
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Success" Dense="true">
                        No critical or high severity findings detected
                    </MudAlert>
                }
            </MudPaper>
        </MudItem>

        <!-- Assessment History -->
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.h6" Class="mb-4">Assessment History</MudText>

                @if (_dashboard.RecentAssessments.Any())
                {
                    <MudTable Items="@_dashboard.RecentAssessments" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Score</MudTh>
                            <MudTh>Change</MudTh>
                            <MudTh>Duration</MudTh>
                            <MudTh>Initiated By</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="assessment">
                            <MudTd>@assessment.StartedAt.ToString("MMM dd, yyyy HH:mm")</MudTd>
                            <MudTd>
                                <MudChip Size="Size.Small" Color="@GetStatusColor(assessment.Status)" Variant="Variant.Filled">
                                    @assessment.Status
                                </MudChip>
                            </MudTd>
                            <MudTd>
                                @if (assessment.OverallScore.HasValue)
                                {
                                    <MudChip Size="Size.Small" Style="@($"background: {GetScoreColor(assessment.OverallScore.Value)}; color: white;")">
                                        @assessment.OverallScore%
                                    </MudChip>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </MudTd>
                            <MudTd>
                                @{
                                    var idx = _dashboard.RecentAssessments.IndexOf(assessment);
                                    var prevAssessment = idx < _dashboard.RecentAssessments.Count - 1 ? _dashboard.RecentAssessments[idx + 1] : null;
                                    if (assessment.OverallScore.HasValue && prevAssessment?.OverallScore.HasValue == true)
                                    {
                                        var change = assessment.OverallScore.Value - prevAssessment.OverallScore.Value;
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@(change > 0 ? Icons.Material.Filled.TrendingUp : change < 0 ? Icons.Material.Filled.TrendingDown : Icons.Material.Filled.TrendingFlat)"
                                                     Color="@(change > 0 ? Color.Success : change < 0 ? Color.Error : Color.Default)"
                                                     Size="Size.Small" />
                                            <MudText Typo="Typo.body2" Style="@($"color: {(change > 0 ? "#4CAF50" : change < 0 ? "#f44336" : "#666")}; margin-left: 4px;")">
                                                @(change > 0 ? "+" : "")@change%
                                            </MudText>
                                        </div>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                }
                            </MudTd>
                            <MudTd>@(assessment.Duration?.ToString(@"mm\:ss") ?? "-")</MudTd>
                            <MudTd>@(assessment.InitiatedBy ?? "System")</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                               OnClick="@(() => NavigationManager.NavigateTo($"/assessments/{assessment.Id}"))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Download" Size="Size.Small"
                                               OnClick="@(() => DownloadReport(assessment.Id))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                        No assessments have been run for this tenant
                    </MudText>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
}

<style>
    .resource-stat-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .resource-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #E0FC8E;
    }
</style>

@code {
    [Parameter]
    public Guid TenantId { get; set; }

    private bool _isLoading = true;
    private TenantDto? _tenant;
    private TenantDashboardDto _dashboard = new();
    private ResourceStatisticsDto? _resourceStats;

    private List<ChartSeries> _scoreTrendSeries = new();
    private string[] _scoreTrendLabels = Array.Empty<string>();
    private ChartOptions _chartOptions = new() { YAxisTicks = 10 };

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;

        try
        {
            _tenant = await TenantService.GetByIdAsync(TenantId);
            if (_tenant != null)
            {
                var dashboardTask = DashboardService.GetTenantDashboardAsync(TenantId);
                var resourceStatsTask = DashboardService.GetResourceStatisticsAsync(TenantId);

                await Task.WhenAll(dashboardTask, resourceStatsTask);

                _dashboard = await dashboardTask;
                _resourceStats = await resourceStatsTask;
                PrepareChartData();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenant data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void PrepareChartData()
    {
        if (_dashboard.ScoreTrend.Any())
        {
            _scoreTrendLabels = _dashboard.ScoreTrend.Select(p => p.Label).ToArray();
            _scoreTrendSeries = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Score",
                    Data = _dashboard.ScoreTrend.Select(p => (double)p.Score).ToArray()
                }
            };
        }
    }

    private void EditTenant()
    {
        NavigationManager.NavigateTo($"/tenants/{TenantId}/edit");
    }

    private void StartAssessment()
    {
        NavigationManager.NavigateTo($"/assessments/new?tenantId={TenantId}");
    }

    private void CompareAssessments()
    {
        NavigationManager.NavigateTo($"/assessments/compare/{TenantId}");
    }

    private async Task DownloadReport(Guid runId)
    {
        try
        {
            var reportData = await AssessmentService.ExportReportAsync(runId, ReportFormat.Pdf);
            // Handle download
            Snackbar.Add("Report download started", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading report: {ex.Message}", Severity.Error);
        }
    }

    private string GetScoreColor(int score) => score switch
    {
        >= 90 => "#4CAF50",
        >= 80 => "#8BC34A",
        >= 70 => "#FFC107",
        >= 60 => "#FF9800",
        _ => "#f44336"
    };

    private Color GetProgressColor(int score) => score switch
    {
        >= 90 => Color.Success,
        >= 80 => Color.Success,
        >= 70 => Color.Warning,
        >= 60 => Color.Warning,
        _ => Color.Error
    };

    private string GetGrade(int score) => score switch
    {
        >= 90 => "A",
        >= 80 => "B",
        >= 70 => "C",
        >= 60 => "D",
        _ => "F"
    };

    private Color GetStatusColor(AssessmentStatus status) => status switch
    {
        AssessmentStatus.Completed => Color.Success,
        AssessmentStatus.Running => Color.Info,
        AssessmentStatus.Failed => Color.Error,
        AssessmentStatus.Cancelled => Color.Warning,
        _ => Color.Default
    };

    private Color GetSeverityColor(DomainSeverity severity) => severity switch
    {
        DomainSeverity.Critical => Color.Error,
        DomainSeverity.High => Color.Warning,
        DomainSeverity.Medium => Color.Info,
        DomainSeverity.Low => Color.Default,
        _ => Color.Default
    };

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalDays > 30) return $"{(int)(span.TotalDays / 30)} months ago";
        if (span.TotalDays > 1) return $"{(int)span.TotalDays} days ago";
        if (span.TotalHours > 1) return $"{(int)span.TotalHours} hours ago";
        return "Just now";
    }
}
