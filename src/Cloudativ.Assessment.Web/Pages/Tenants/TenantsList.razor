@page "/tenants"
@attribute [Authorize]
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Tenants - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">Tenants</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
               OnClick="@(() => NavigationManager.NavigateTo("/tenants/new"))">
        Add Tenant
    </MudButton>
</div>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
        <MudTextField @bind-Value="_searchString" Placeholder="Search tenants..." Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mb-4"
                      Immediate="true" />

        <MudTable Items="@FilteredTenants" Hover="true" Dense="true" Striped="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<TenantDto, object>(x => x.Name)">Name</MudTableSortLabel></MudTh>
                <MudTh>Domain</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Last Assessment</MudTh>
                <MudTh>Score</MudTh>
                <MudTh>Assessments</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <div class="d-flex align-center">
                        <MudAvatar Size="Size.Small" Style="background: #E0FC8E; color: #51627A;" Class="mr-2">
                            @context.Name[0]
                        </MudAvatar>
                        <div>
                            <MudLink Href="@($"/tenants/{context.Id}")" Typo="Typo.body2" Style="font-weight: 500;">
                                @context.Name
                            </MudLink>
                            @if (!string.IsNullOrEmpty(context.Industry))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Industry</MudText>
                            }
                        </div>
                    </div>
                </MudTd>
                <MudTd>@context.Domain</MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="@GetStatusColor(context.OnboardingStatus)" Variant="Variant.Filled">
                        @context.OnboardingStatus
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (context.LastAssessmentDate.HasValue)
                    {
                        <MudText Typo="Typo.body2">@context.LastAssessmentDate.Value.ToString("MMM dd, yyyy")</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Never</MudText>
                    }
                </MudTd>
                <MudTd>
                    @if (context.LastAssessmentScore.HasValue)
                    {
                        <MudChip Size="Size.Small" Style="@($"background: {GetScoreColor(context.LastAssessmentScore.Value)}; color: white;")">
                            @context.LastAssessmentScore%
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd>@context.TotalAssessments</MudTd>
                <MudTd>
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility"
                                     OnClick="@(() => NavigationManager.NavigateTo($"/tenants/{context.Id}"))">
                            View Details
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.PlayArrow"
                                     OnClick="@(() => NavigationManager.NavigateTo($"/assessments/new?tenantId={context.Id}"))">
                            Run Assessment
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                     OnClick="@(() => NavigationManager.NavigateTo($"/tenants/{context.Id}/edit"))">
                            Edit
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Settings"
                                     OnClick="@(() => NavigationManager.NavigateTo($"/tenants/{context.Id}/onboarding"))">
                            Configure
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error"
                                     OnClick="@(() => ConfirmDelete(context))">
                            Delete
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Class="pa-4 text-center">
                    No tenants found. <MudLink Href="/tenants/new">Add your first tenant</MudLink> to get started.
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

@code {
    private bool _isLoading = true;
    private List<TenantDto> _tenants = new();
    private string _searchString = string.Empty;

    private IEnumerable<TenantDto> FilteredTenants => string.IsNullOrWhiteSpace(_searchString)
        ? _tenants
        : _tenants.Where(t =>
            t.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            t.Domain.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            (t.Industry?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false));

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
    }

    private async Task LoadTenantsAsync()
    {
        _isLoading = true;
        try
        {
            _tenants = (await TenantService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenants: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ConfirmDelete(TenantDto tenant)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Tenant",
            $"Are you sure you want to delete '{tenant.Name}'? This will also delete all assessment data.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await TenantService.DeleteAsync(tenant.Id);
                Snackbar.Add($"Tenant '{tenant.Name}' deleted successfully", Severity.Success);
                await LoadTenantsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting tenant: {ex.Message}", Severity.Error);
            }
        }
    }

    private string GetScoreColor(int score) => score switch
    {
        >= 90 => "#4CAF50",
        >= 80 => "#8BC34A",
        >= 70 => "#FFC107",
        >= 60 => "#FF9800",
        _ => "#f44336"
    };

    private Color GetStatusColor(OnboardingStatus status) => status switch
    {
        OnboardingStatus.Active => Color.Success,
        OnboardingStatus.Validated => Color.Info,
        OnboardingStatus.PermissionsGranted => Color.Info,
        OnboardingStatus.InProgress => Color.Warning,
        OnboardingStatus.Pending => Color.Default,
        _ => Color.Error
    };
}
