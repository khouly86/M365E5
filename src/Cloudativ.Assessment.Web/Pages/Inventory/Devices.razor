@page "/inventory/devices"
@attribute [Authorize]
@inject IInventoryService InventoryService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Device Inventory - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">Device Inventory</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Managed devices, compliance status, and Defender enrollment</MudText>
    </div>
    <div class="d-flex gap-2 align-center">
        <MudSelect T="Guid?" Label="Tenant" @bind-Value="_selectedTenantId" Dense="true"
                   Style="min-width: 200px;" Variant="Variant.Outlined">
            @foreach (var tenant in _tenants)
            {
                <MudSelectItem Value="@((Guid?)tenant.Id)">@tenant.Name</MudSelectItem>
            }
        </MudSelect>
        <Cloudativ.Assessment.Web.Shared.Components.ExportDropdown
            ExportType="devices"
            TenantId="_selectedTenantId"
            QueryString="@GetExportQueryString()" />
    </div>
</div>

<!-- Filter Panel -->
<MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 12px;">
    <MudGrid>
        <MudItem xs="12" md="3">
            <MudTextField @bind-Value="_filter.SearchTerm" Label="Search" Placeholder="Device name or serial"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="LoadDevicesAsync" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Label="OS Type" @bind-Value="_filter.OperatingSystem" Dense="true">
                <MudSelectItem Value="@((string?)null)">All OS</MudSelectItem>
                <MudSelectItem Value="@("Windows")">Windows</MudSelectItem>
                <MudSelectItem Value="@("iOS")">iOS</MudSelectItem>
                <MudSelectItem Value="@("Android")">Android</MudSelectItem>
                <MudSelectItem Value="@("macOS")">macOS</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Label="Compliance" @bind-Value="_filter.ComplianceState" Dense="true">
                <MudSelectItem Value="@((string?)null)">All</MudSelectItem>
                <MudSelectItem Value="@("compliant")">Compliant</MudSelectItem>
                <MudSelectItem Value="@("noncompliant")">Non-Compliant</MudSelectItem>
                <MudSelectItem Value="@("unknown")">Unknown</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="Defender" @bind-Value="_filter.HasDefender" Dense="true">
                <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">Enrolled</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Not Enrolled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Label="Ownership" @bind-Value="_filter.OwnerType" Dense="true">
                <MudSelectItem Value="@((string?)null)">All</MudSelectItem>
                <MudSelectItem Value="@("corporate")">Corporate</MudSelectItem>
                <MudSelectItem Value="@("personal")">Personal</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="1" Class="d-flex align-end">
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearFilters">Clear</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- Quick Stats -->
<MudGrid Class="mb-4">
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Devices</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.Total.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #4CAF50;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Compliant</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #4CAF50;">@_stats.Compliant.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #f44336;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Non-Compliant</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #f44336;">@_stats.NonCompliant.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #2196F3;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Encrypted</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.Encrypted.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #51627A;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Defender</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.WithDefender.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #ff9800;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">At Risk</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #ff9800;">@_stats.AtRisk.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Elevation="2" Style="border-radius: 12px;">
        <MudTable Items="_devices" Dense="true" Hover="true" Striped="true"
                  ServerData="@(new Func<TableState, Task<TableData<DeviceInventoryDto>>>(ServerReload))"
                  @ref="_table">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortLabel="deviceName" T="DeviceInventoryDto">Device</MudTableSortLabel></MudTh>
                <MudTh>OS</MudTh>
                <MudTh>Owner</MudTh>
                <MudTh><MudTableSortLabel SortLabel="complianceState" T="DeviceInventoryDto">Compliance</MudTableSortLabel></MudTh>
                <MudTh>Encryption</MudTh>
                <MudTh>Defender</MudTh>
                <MudTh><MudTableSortLabel SortLabel="riskScore" T="DeviceInventoryDto">Risk</MudTableSortLabel></MudTh>
                <MudTh>Last Sync</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@GetDeviceIcon(context.OperatingSystem)" Class="mr-2" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.DeviceName</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.SerialNumber</MudText>
                        </div>
                    </div>
                </MudTd>
                <MudTd>
                    <MudText Typo="Typo.body2">@context.OperatingSystem</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.OsVersion</MudText>
                </MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="@(context.OwnerType == "corporate" ? Color.Primary : Color.Secondary)" Variant="Variant.Outlined">
                        @context.OwnerType
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="@GetComplianceColor(context.ComplianceState)" Variant="Variant.Filled">
                        @context.ComplianceState
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (context.IsEncrypted)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Success" Size="Size.Small" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.LockOpen" Color="Color.Error" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd>
                    @if (context.HasDefenderForEndpoint)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Success" Size="Size.Small" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Outlined.Shield" Color="Color.Warning" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="@GetRiskColor(context.RiskScore)">
                        @(context.RiskScore ?? "None")
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (context.LastSyncDateTime.HasValue)
                    {
                        <MudText Typo="Typo.body2">@context.LastSyncDateTime.Value.ToString("MMM dd, yyyy")</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Never</MudText>
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                   OnClick="@(() => ViewDeviceDetails(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Class="pa-4 text-center">
                    No devices found matching the current filters.
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 250 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

<!-- Device Details Dialog -->
<MudDialog @bind-Visible="_showDeviceDialog" Options="_dialogOptions">
    <DialogContent>
        @if (_selectedDevice != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <div class="d-flex align-center mb-4">
                        <MudIcon Icon="@GetDeviceIcon(_selectedDevice.OperatingSystem)" Size="Size.Large" Color="Color.Primary" Class="mr-3" />
                        <div>
                            <MudText Typo="Typo.h6">@_selectedDevice.DeviceName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedDevice.OperatingSystem @_selectedDevice.OsVersion</MudText>
                        </div>
                    </div>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Device ID</MudText>
                    <MudText Typo="Typo.body2">@_selectedDevice.DeviceId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Serial Number</MudText>
                    <MudText Typo="Typo.body2">@_selectedDevice.SerialNumber</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Ownership</MudText>
                    <MudText Typo="Typo.body2">@_selectedDevice.OwnerType</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Enrollment Type</MudText>
                    <MudText Typo="Typo.body2">@_selectedDevice.EnrollmentType</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Security Status</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Compliance</MudText>
                    <MudChip Size="Size.Small" Color="@GetComplianceColor(_selectedDevice.ComplianceState)">
                        @_selectedDevice.ComplianceState
                    </MudChip>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Encryption</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedDevice.IsEncrypted)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> <span>Encrypted</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" Size="Size.Small" /> <span>Not Encrypted</span>
                        }
                    </MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Azure AD Joined</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedDevice.IsAzureAdJoined)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> <span>Yes</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Warning" Size="Size.Small" /> <span>No</span>
                        }
                    </MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Defender for Endpoint</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedDevice.HasDefenderForEndpoint)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Success" Size="Size.Small" /> <span>Enrolled</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Outlined.Shield" Color="Color.Warning" Size="Size.Small" /> <span>Not Enrolled</span>
                        }
                    </MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Recovery Key Escrowed</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedDevice.RecoveryKeyEscrowed)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Success" Size="Size.Small" /> <span>Yes</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.KeyOff" Color="Color.Warning" Size="Size.Small" /> <span>No</span>
                        }
                    </MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Risk Score</MudText>
                    <MudChip Size="Size.Small" Color="@GetRiskColor(_selectedDevice.RiskScore)">
                        @(_selectedDevice.RiskScore ?? "None")
                    </MudChip>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@(() => _showDeviceDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private bool _isLoading = true;
    private List<TenantDto> _tenants = new();
    private Guid? _selectedTenantId;
    private List<DeviceInventoryDto> _devices = new();
    private MudTable<DeviceInventoryDto>? _table;
    private DeviceInventoryFilter _filter = new();
    private DeviceInventoryDto? _selectedDevice;
    private bool _showDeviceDialog = false;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    private (int Total, int Compliant, int NonCompliant, int Encrypted, int WithDefender, int AtRisk) _stats;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();

        _selectedTenantId = TenantId ?? _tenants.FirstOrDefault()?.Id;
        _filter.TenantId = _selectedTenantId ?? Guid.Empty;

        _isLoading = false;
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _tenants = (await TenantService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenants: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadDevicesAsync()
    {
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task<TableData<DeviceInventoryDto>> ServerReload(TableState state)
    {
        if (!_selectedTenantId.HasValue)
        {
            return new TableData<DeviceInventoryDto> { Items = new List<DeviceInventoryDto>(), TotalItems = 0 };
        }

        try
        {
            _filter.TenantId = _selectedTenantId.Value;
            _filter.Page = state.Page + 1;
            _filter.PageSize = state.PageSize;
            _filter.SortBy = state.SortLabel;
            _filter.SortDescending = state.SortDirection == SortDirection.Descending;

            var result = await InventoryService.GetDevicesAsync(_selectedTenantId.Value, _filter);

            return new TableData<DeviceInventoryDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading devices: {ex.Message}", Severity.Error);
            return new TableData<DeviceInventoryDto> { Items = new List<DeviceInventoryDto>(), TotalItems = 0 };
        }
    }

    private void ClearFilters()
    {
        _filter = new DeviceInventoryFilter { TenantId = _selectedTenantId ?? Guid.Empty };
        _table?.ReloadServerData();
    }

    private void ViewDeviceDetails(DeviceInventoryDto device)
    {
        _selectedDevice = device;
        _showDeviceDialog = true;
    }

    private string GetExportQueryString()
    {
        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(_filter.SearchTerm)) queryParams.Add($"searchTerm={Uri.EscapeDataString(_filter.SearchTerm)}");
        if (!string.IsNullOrEmpty(_filter.OperatingSystem)) queryParams.Add($"operatingSystem={Uri.EscapeDataString(_filter.OperatingSystem)}");
        if (!string.IsNullOrEmpty(_filter.ComplianceState)) queryParams.Add($"complianceState={Uri.EscapeDataString(_filter.ComplianceState)}");
        return string.Join("&", queryParams);
    }

    private string GetDeviceIcon(string? os) => os?.ToLower() switch
    {
        "windows" => Icons.Material.Filled.DesktopWindows,
        "ios" => Icons.Material.Filled.PhoneIphone,
        "android" => Icons.Material.Filled.PhoneAndroid,
        "macos" => Icons.Material.Filled.LaptopMac,
        _ => Icons.Material.Filled.Devices
    };

    private Color GetComplianceColor(string? state) => state?.ToLower() switch
    {
        "compliant" => Color.Success,
        "noncompliant" => Color.Error,
        _ => Color.Warning
    };

    private Color GetRiskColor(string? risk) => risk?.ToLower() switch
    {
        "high" => Color.Error,
        "medium" => Color.Warning,
        "low" => Color.Info,
        _ => Color.Default
    };
}
