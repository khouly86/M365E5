@page "/inventory/high-risk"
@attribute [Authorize]
@inject IInventoryService InventoryService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>High-Risk Findings - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">High-Risk Findings</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Auto-detected security risks requiring immediate attention</MudText>
    </div>
    <div class="d-flex gap-2 align-center">
        <MudSelect T="Guid?" Label="Tenant" Value="_selectedTenantId" Dense="true"
                   Style="min-width: 200px;" Variant="Variant.Outlined"
                   ValueChanged="@(async (Guid? v) => { _selectedTenantId = v; await LoadFindingsAsync(); })">
            @foreach (var tenant in _tenants)
            {
                <MudSelectItem Value="@((Guid?)tenant.Id)">@tenant.Name</MudSelectItem>
            }
        </MudSelect>
        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Download">Export Report</MudButton>
    </div>
</div>

<!-- Severity Summary -->
<MudGrid Class="mb-4">
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #d32f2f;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Critical</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 600; color: #d32f2f;">@_findings.Count(f => f.Severity == "Critical")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Style="color: #d32f2f;" />
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #f57c00;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">High</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 600; color: #f57c00;">@_findings.Count(f => f.Severity == "High")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" Style="color: #f57c00;" />
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #fbc02d;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Medium</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 600; color: #fbc02d;">@_findings.Count(f => f.Severity == "Medium")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Large" Style="color: #fbc02d;" />
            </div>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #388e3c;">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Low</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 600; color: #388e3c;">@_findings.Count(f => f.Severity == "Low")</MudText>
                </div>
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Style="color: #388e3c;" />
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Filter Chips -->
<div class="d-flex gap-2 mb-4 flex-wrap">
    <MudChip Color="@(_severityFilter == null ? Color.Primary : Color.Default)"
             Variant="@(_severityFilter == null ? Variant.Filled : Variant.Outlined)"
             OnClick="@(() => { _severityFilter = null; })">All</MudChip>
    <MudChip Color="@(_severityFilter == "Critical" ? Color.Error : Color.Default)"
             Variant="@(_severityFilter == "Critical" ? Variant.Filled : Variant.Outlined)"
             OnClick="@(() => { _severityFilter = "Critical"; })">Critical Only</MudChip>
    <MudChip Color="@(_severityFilter == "High" ? Color.Warning : Color.Default)"
             Variant="@(_severityFilter == "High" ? Variant.Filled : Variant.Outlined)"
             OnClick="@(() => { _severityFilter = "High"; })">High Only</MudChip>
</div>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (!_findings.Any())
{
    <MudPaper Class="pa-8 text-center" Elevation="2" Style="border-radius: 12px;">
        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" Class="mb-4" />
        <MudText Typo="Typo.h6">No High-Risk Findings</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Great job! No critical security issues were detected in the latest inventory collection.
        </MudText>
    </MudPaper>
}
else
{
    @foreach (var finding in FilteredFindings)
    {
        <MudPaper Class="pa-4 mb-3" Elevation="2" Style="@GetFindingStyle(finding.Severity)">
            <div class="d-flex justify-space-between align-start">
                <div class="d-flex align-start">
                    <MudIcon Icon="@GetSeverityIcon(finding.Severity)"
                             Style="@($"color: {GetSeverityColor(finding.Severity)};")"
                             Size="Size.Medium" Class="mr-3 mt-1" />
                    <div>
                        <div class="d-flex align-center gap-2 mb-1">
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@finding.Title</MudText>
                            <MudChip Size="Size.Small" Color="@GetSeverityChipColor(finding.Severity)" Variant="Variant.Filled">
                                @finding.Severity
                            </MudChip>
                            <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                                @finding.FindingType
                            </MudChip>
                        </div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            @finding.Description
                        </MudText>
                        <div class="d-flex align-center gap-4">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Secondary" Class="mr-1" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @finding.AffectedCount affected resources
                                </MudText>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-column align-end">
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => ViewFindingDetails(finding))">
                        View Details
                    </MudButton>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(finding.Remediation))
            {
                <MudDivider Class="my-3" />
                <div class="d-flex align-start">
                    <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Size="Size.Small" Color="Color.Warning" Class="mr-2 mt-1" />
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight: 600;">REMEDIATION</MudText>
                        <MudText Typo="Typo.body2">@finding.Remediation</MudText>
                    </div>
                </div>
            }
        </MudPaper>
    }
}

<!-- Finding Details Dialog -->
<MudDialog @bind-Visible="_showFindingDialog" Options="_dialogOptions">
    <DialogContent>
        @if (_selectedFinding != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <div class="d-flex align-center mb-4">
                        <MudIcon Icon="@GetSeverityIcon(_selectedFinding.Severity)"
                                 Style="@($"color: {GetSeverityColor(_selectedFinding.Severity)};")"
                                 Size="Size.Large" Class="mr-3" />
                        <div>
                            <MudText Typo="Typo.h6">@_selectedFinding.Title</MudText>
                            <div class="d-flex gap-2 mt-1">
                                <MudChip Size="Size.Small" Color="@GetSeverityChipColor(_selectedFinding.Severity)">@_selectedFinding.Severity</MudChip>
                                <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">@_selectedFinding.FindingType</MudChip>
                            </div>
                        </div>
                    </div>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.body1">@_selectedFinding.Description</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Affected Resources (@_selectedFinding.AffectedCount)</MudText>
                    <MudPaper Class="pa-3" Elevation="0" Style="background: #f5f5f5; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                        @foreach (var resource in _selectedFinding.AffectedResources.Take(50))
                        {
                            <div class="d-flex align-center py-1">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" Class="mr-2" />
                                <MudText Typo="Typo.body2">@resource</MudText>
                            </div>
                        }
                        @if (_selectedFinding.AffectedResources.Count > 50)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                ... and @(_selectedFinding.AffectedResources.Count - 50) more resources
                            </MudText>
                        }
                    </MudPaper>
                </MudItem>
                @if (!string.IsNullOrEmpty(_selectedFinding.Remediation))
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Remediation Steps</MudText>
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            @_selectedFinding.Remediation
                        </MudAlert>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Secondary" OnClick="@(() => _showFindingDialog = false)">Close</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Download">
            Export Finding
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private bool _isLoading = true;
    private List<TenantDto> _tenants = new();
    private Guid? _selectedTenantId;
    private List<HighRiskFindingSummaryDto> _findings = new();
    private HighRiskFindingSummaryDto? _selectedFinding;
    private bool _showFindingDialog = false;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };
    private string? _severityFilter;

    private IEnumerable<HighRiskFindingSummaryDto> FilteredFindings => _severityFilter == null
        ? _findings
        : _findings.Where(f => f.Severity == _severityFilter);

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
        _selectedTenantId = TenantId ?? _tenants.FirstOrDefault()?.Id;

        if (_selectedTenantId.HasValue)
            await LoadFindingsAsync();

        _isLoading = false;
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _tenants = (await TenantService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenants: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadFindingsAsync()
    {
        if (!_selectedTenantId.HasValue) return;

        _isLoading = true;
        try
        {
            var result = await InventoryService.GetHighRiskFindingsAsync(_selectedTenantId.Value);
            _findings = result.OrderBy(f => GetSeverityOrder(f.Severity)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading findings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ViewFindingDetails(HighRiskFindingSummaryDto finding)
    {
        _selectedFinding = finding;
        _showFindingDialog = true;
    }

    private int GetSeverityOrder(string severity) => severity switch
    {
        "Critical" => 0,
        "High" => 1,
        "Medium" => 2,
        "Low" => 3,
        _ => 4
    };

    private string GetSeverityIcon(string severity) => severity switch
    {
        "Critical" => Icons.Material.Filled.Error,
        "High" => Icons.Material.Filled.Warning,
        "Medium" => Icons.Material.Filled.Info,
        _ => Icons.Material.Filled.CheckCircle
    };

    private string GetSeverityColor(string severity) => severity switch
    {
        "Critical" => "#d32f2f",
        "High" => "#f57c00",
        "Medium" => "#fbc02d",
        _ => "#388e3c"
    };

    private Color GetSeverityChipColor(string severity) => severity switch
    {
        "Critical" => Color.Error,
        "High" => Color.Warning,
        "Medium" => Color.Info,
        _ => Color.Success
    };

    private string GetFindingStyle(string severity)
    {
        var borderColor = GetSeverityColor(severity);
        return $"border-radius: 12px; border-left: 4px solid {borderColor};";
    }
}
