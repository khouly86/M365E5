@page "/inventory/applications"
@attribute [Authorize]
@inject IInventoryService InventoryService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Enterprise Applications - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">Enterprise Applications</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">App registrations, OAuth permissions, and credential status</MudText>
    </div>
    <div class="d-flex gap-2 align-center">
        <MudSelect T="Guid?" Label="Tenant" @bind-Value="_selectedTenantId" Dense="true"
                   Style="min-width: 200px;" Variant="Variant.Outlined">
            @foreach (var tenant in _tenants)
            {
                <MudSelectItem Value="@((Guid?)tenant.Id)">@tenant.Name</MudSelectItem>
            }
        </MudSelect>
        <Cloudativ.Assessment.Web.Shared.Components.ExportDropdown
            ExportType="apps"
            TenantId="_selectedTenantId"
            QueryString="@GetExportQueryString()" />
    </div>
</div>

<!-- Filter Panel -->
<MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 12px;">
    <MudGrid>
        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="_filter.SearchTerm" Label="Search" Placeholder="App name or ID"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="LoadAppsAsync" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="Microsoft Apps" @bind-Value="_filter.IsMicrosoftApp" Dense="true">
                <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">Microsoft Only</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Third-Party Only</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="High Privilege" @bind-Value="_filter.HasHighPrivilegePermissions" Dense="true">
                <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">High Privilege</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Standard</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="Credential Status" @bind-Value="_filter.HasExpiredCredentials" Dense="true">
                <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">Expired</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Valid</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2" Class="d-flex align-end">
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearFilters">Clear</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- Quick Stats -->
<MudGrid Class="mb-4">
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Apps</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.Total.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #2196F3;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Microsoft</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.Microsoft.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #9C27B0;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Third-Party</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.ThirdParty.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #f44336;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">High Privilege</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #f44336;">@_stats.HighPrivilege.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #ff9800;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Expired Creds</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #ff9800;">@_stats.ExpiredCreds.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #4CAF50;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Verified</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.Verified.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Elevation="2" Style="border-radius: 12px;">
        <MudTable Items="_apps" Dense="true" Hover="true" Striped="true"
                  ServerData="@(new Func<TableState, Task<TableData<EnterpriseAppDto>>>(ServerReload))"
                  @ref="_table">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortLabel="displayName" T="EnterpriseAppDto">Application</MudTableSortLabel></MudTh>
                <MudTh>Publisher</MudTh>
                <MudTh>Permissions</MudTh>
                <MudTh>Credentials</MudTh>
                <MudTh>Risky Permissions</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <div class="d-flex align-center">
                        <MudAvatar Size="Size.Small" Style="@GetAppAvatarStyle(context)" Class="mr-2">
                            <MudIcon Icon="@Icons.Material.Filled.Apps" Size="Size.Small" />
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.DisplayName</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.AppId</MudText>
                        </div>
                    </div>
                </MudTd>
                <MudTd>
                    <div class="d-flex align-center">
                        @if (context.IsMicrosoftApp)
                        {
                            <MudChip Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">Microsoft</MudChip>
                        }
                        else if (context.IsVerifiedPublisher)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Verified" Color="Color.Success" Size="Size.Small" Class="mr-1" />
                            <MudText Typo="Typo.caption">Verified</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Unverified</MudText>
                        }
                    </div>
                </MudTd>
                <MudTd>
                    <div class="d-flex flex-column">
                        <MudText Typo="Typo.caption">App: @context.ApplicationPermissions.Count</MudText>
                        <MudText Typo="Typo.caption">Delegated: @context.DelegatedPermissions.Count</MudText>
                    </div>
                </MudTd>
                <MudTd>
                    @if (context.HasExpiredCredentials)
                    {
                        <MudChip Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">Expired</MudChip>
                    }
                    else if (context.NextCredentialExpiration.HasValue)
                    {
                        var daysUntilExpiry = (context.NextCredentialExpiration.Value - DateTime.UtcNow).Days;
                        <MudChip Size="Size.Small" Color="@(daysUntilExpiry <= 30 ? Color.Warning : Color.Success)" Variant="Variant.Outlined">
                            @(daysUntilExpiry <= 0 ? "Expired" : $"{daysUntilExpiry}d left")
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">No creds</MudText>
                    }
                </MudTd>
                <MudTd>
                    @if (context.HasHighPrivilegePermissions)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" />
                    }
                    <div class="d-flex flex-wrap gap-1" style="max-width: 200px;">
                        @if (context.HasMailReadWrite)
                        {
                            <MudChip Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined">Mail.ReadWrite</MudChip>
                        }
                        @if (context.HasDirectoryReadWriteAll)
                        {
                            <MudChip Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined">Directory.ReadWrite</MudChip>
                        }
                        @if (context.HasFilesReadWriteAll)
                        {
                            <MudChip Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">Files.ReadWrite</MudChip>
                        }
                    </div>
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                   OnClick="@(() => ViewAppDetails(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Class="pa-4 text-center">No applications found matching the current filters.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 250 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

<!-- App Details Dialog -->
<MudDialog @bind-Visible="_showAppDialog" Options="_dialogOptions">
    <DialogContent>
        @if (_selectedApp != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <div class="d-flex align-center mb-4">
                        <MudAvatar Size="Size.Large" Style="@GetAppAvatarStyle(_selectedApp)" Class="mr-3">
                            <MudIcon Icon="@Icons.Material.Filled.Apps" />
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.h6">@_selectedApp.DisplayName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedApp.AppId</MudText>
                        </div>
                    </div>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Object ID</MudText>
                    <MudText Typo="Typo.body2">@_selectedApp.ObjectId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Publisher</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedApp.IsMicrosoftApp)
                        {
                            <span>Microsoft</span>
                        }
                        else if (_selectedApp.IsVerifiedPublisher)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Verified" Color="Color.Success" Size="Size.Small" /> <span>Verified Publisher</span>
                        }
                        else
                        {
                            <span>Unverified</span>
                        }
                    </MudText>
                </MudItem>
                @if (_selectedApp.ApplicationPermissions.Any())
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Application Permissions (@_selectedApp.ApplicationPermissions.Count)</MudText>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var perm in _selectedApp.ApplicationPermissions.Take(10))
                            {
                                <MudChip Size="Size.Small" Color="@(IsHighRiskPermission(perm) ? Color.Error : Color.Default)">@perm</MudChip>
                            }
                            @if (_selectedApp.ApplicationPermissions.Count > 10)
                            {
                                <MudChip Size="Size.Small" Color="Color.Secondary">+@(_selectedApp.ApplicationPermissions.Count - 10) more</MudChip>
                            }
                        </div>
                    </MudItem>
                }
                @if (_selectedApp.DelegatedPermissions.Any())
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Delegated Permissions (@_selectedApp.DelegatedPermissions.Count)</MudText>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var perm in _selectedApp.DelegatedPermissions.Take(10))
                            {
                                <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">@perm</MudChip>
                            }
                            @if (_selectedApp.DelegatedPermissions.Count > 10)
                            {
                                <MudChip Size="Size.Small" Color="Color.Secondary">+@(_selectedApp.DelegatedPermissions.Count - 10) more</MudChip>
                            }
                        </div>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@(() => _showAppDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private bool _isLoading = true;
    private List<TenantDto> _tenants = new();
    private Guid? _selectedTenantId;
    private List<EnterpriseAppDto> _apps = new();
    private MudTable<EnterpriseAppDto>? _table;
    private AppInventoryFilter _filter = new();
    private EnterpriseAppDto? _selectedApp;
    private bool _showAppDialog = false;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Large, FullWidth = true };

    private (int Total, int Microsoft, int ThirdParty, int HighPrivilege, int ExpiredCreds, int Verified) _stats;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
        _selectedTenantId = TenantId ?? _tenants.FirstOrDefault()?.Id;
        _filter.TenantId = _selectedTenantId ?? Guid.Empty;
        _isLoading = false;
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _tenants = (await TenantService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenants: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAppsAsync()
    {
        if (_table != null) await _table.ReloadServerData();
    }

    private async Task<TableData<EnterpriseAppDto>> ServerReload(TableState state)
    {
        if (!_selectedTenantId.HasValue)
            return new TableData<EnterpriseAppDto> { Items = new List<EnterpriseAppDto>(), TotalItems = 0 };

        try
        {
            _filter.TenantId = _selectedTenantId.Value;
            _filter.Page = state.Page + 1;
            _filter.PageSize = state.PageSize;

            var result = await InventoryService.GetAppsAsync(_selectedTenantId.Value, _filter);

            return new TableData<EnterpriseAppDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading applications: {ex.Message}", Severity.Error);
            return new TableData<EnterpriseAppDto> { Items = new List<EnterpriseAppDto>(), TotalItems = 0 };
        }
    }

    private void ClearFilters()
    {
        _filter = new AppInventoryFilter { TenantId = _selectedTenantId ?? Guid.Empty };
        _table?.ReloadServerData();
    }

    private void ViewAppDetails(EnterpriseAppDto app)
    {
        _selectedApp = app;
        _showAppDialog = true;
    }

    private string GetAppAvatarStyle(EnterpriseAppDto app)
    {
        if (app.IsMicrosoftApp) return "background: #0078D4; color: white;";
        if (app.HasHighPrivilegePermissions) return "background: #FFEBEE; color: #f44336;";
        if (app.IsVerifiedPublisher) return "background: #E8F5E9; color: #4CAF50;";
        return "background: #E0FC8E; color: #51627A;";
    }

    private bool IsHighRiskPermission(string permission)
    {
        var highRisk = new[] { "Mail.ReadWrite", "Directory.ReadWrite.All", "Files.ReadWrite.All", "User.ReadWrite.All", "Application.ReadWrite.All" };
        return highRisk.Any(hr => permission.Contains(hr, StringComparison.OrdinalIgnoreCase));
    }

    private string GetExportQueryString()
    {
        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(_filter.SearchTerm)) queryParams.Add($"searchTerm={Uri.EscapeDataString(_filter.SearchTerm)}");
        return string.Join("&", queryParams);
    }
}
