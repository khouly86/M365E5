@page "/inventory/service-principals"
@attribute [Authorize]
@inject IInventoryService InventoryService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Service Principals - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">Service Principals</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Application identities and managed identities</MudText>
    </div>
    <div class="d-flex gap-2 align-center">
        <MudSelect T="Guid?" Label="Tenant" @bind-Value="_selectedTenantId" Dense="true"
                   Style="min-width: 200px;" Variant="Variant.Outlined">
            @foreach (var tenant in _tenants)
            {
                <MudSelectItem Value="@((Guid?)tenant.Id)">@tenant.Name</MudSelectItem>
            }
        </MudSelect>
        <Cloudativ.Assessment.Web.Shared.Components.ExportDropdown
            ExportType="service-principals"
            TenantId="_selectedTenantId" />
    </div>
</div>

<!-- Quick Stats -->
<MudGrid Class="mb-4">
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Total</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_servicePrincipals.Count</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #2196F3;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Microsoft</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_servicePrincipals.Count(s => s.IsMicrosoftFirstParty)</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #9C27B0;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Third-Party</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_servicePrincipals.Count(s => !s.IsMicrosoftFirstParty)</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #f44336;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">High Privilege</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #f44336;">@_servicePrincipals.Count(s => s.HasHighPrivilegePermissions)</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #4CAF50;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Managed Identity</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_servicePrincipals.Count(s => s.ServicePrincipalType == "ManagedIdentity")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="2">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #ff9800;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">App Permissions</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_servicePrincipals.Sum(s => s.ApplicationPermissions.Count)</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Elevation="2" Style="border-radius: 12px;">
        <MudTable Items="_servicePrincipals" Dense="true" Hover="true" Striped="true"
                  Filter="new Func<ServicePrincipalDto, bool>(FilterFunc)">
            <ToolBarContent>
                <MudTextField @bind-Value="_searchString" Placeholder="Search..." Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                              Immediate="true" Class="mt-0" />
                <MudSpacer />
                <MudChip Color="@(_showHighPrivilegeOnly ? Color.Error : Color.Default)"
                         Variant="@(_showHighPrivilegeOnly ? Variant.Filled : Variant.Outlined)"
                         OnClick="@(() => _showHighPrivilegeOnly = !_showHighPrivilegeOnly)">
                    High Privilege Only
                </MudChip>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Service Principal</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Publisher</MudTh>
                <MudTh>App Permissions</MudTh>
                <MudTh>Delegated</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <div class="d-flex align-center">
                        <MudIcon Icon="@GetServicePrincipalIcon(context)"
                                 Color="@GetServicePrincipalColor(context)"
                                 Size="Size.Small" Class="mr-2" />
                        <div>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.DisplayName</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.AppId</MudText>
                        </div>
                    </div>
                </MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                        @context.ServicePrincipalType
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (context.IsMicrosoftFirstParty)
                    {
                        <MudChip Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">Microsoft</MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Third-Party</MudText>
                    }
                </MudTd>
                <MudTd>
                    @if (context.ApplicationPermissions.Any())
                    {
                        <MudChip Size="Size.Small" Color="@(context.HasHighPrivilegePermissions ? Color.Error : Color.Default)">
                            @context.ApplicationPermissions.Count
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">0</MudText>
                    }
                </MudTd>
                <MudTd>@context.DelegatedPermissions.Count</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                   OnClick="@(() => ViewDetails(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Class="pa-4 text-center">No service principals found.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 250 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

<!-- Details Dialog -->
<MudDialog @bind-Visible="_showDialog" Options="_dialogOptions">
    <DialogContent>
        @if (_selectedSp != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <div class="d-flex align-center mb-4">
                        <MudIcon Icon="@GetServicePrincipalIcon(_selectedSp)"
                                 Color="@GetServicePrincipalColor(_selectedSp)"
                                 Size="Size.Large" Class="mr-3" />
                        <div>
                            <MudText Typo="Typo.h6">@_selectedSp.DisplayName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedSp.AppId</MudText>
                        </div>
                    </div>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Object ID</MudText>
                    <MudText Typo="Typo.body2">@_selectedSp.ObjectId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Type</MudText>
                    <MudText Typo="Typo.body2">@_selectedSp.ServicePrincipalType</MudText>
                </MudItem>
                @if (_selectedSp.ApplicationPermissions.Any())
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Application Permissions (@_selectedSp.ApplicationPermissions.Count)</MudText>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var perm in _selectedSp.ApplicationPermissions)
                            {
                                <MudChip Size="Size.Small" Color="@(IsHighRiskPermission(perm) ? Color.Error : Color.Default)">@perm</MudChip>
                            }
                        </div>
                    </MudItem>
                }
                @if (_selectedSp.DelegatedPermissions.Any())
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Delegated Permissions (@_selectedSp.DelegatedPermissions.Count)</MudText>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var perm in _selectedSp.DelegatedPermissions)
                            {
                                <MudChip Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">@perm</MudChip>
                            }
                        </div>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@(() => _showDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private bool _isLoading = true;
    private List<TenantDto> _tenants = new();
    private Guid? _selectedTenantId;
    private List<ServicePrincipalDto> _servicePrincipals = new();
    private ServicePrincipalDto? _selectedSp;
    private bool _showDialog = false;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Large, FullWidth = true };
    private string _searchString = "";
    private bool _showHighPrivilegeOnly = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
        _selectedTenantId = TenantId ?? _tenants.FirstOrDefault()?.Id;

        if (_selectedTenantId.HasValue)
            await LoadDataAsync();

        _isLoading = false;
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _tenants = (await TenantService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenants: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadDataAsync()
    {
        if (!_selectedTenantId.HasValue) return;

        try
        {
            var result = await InventoryService.GetServicePrincipalsAsync(_selectedTenantId.Value);
            _servicePrincipals = result.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterFunc(ServicePrincipalDto sp)
    {
        if (_showHighPrivilegeOnly && !sp.HasHighPrivilegePermissions) return false;
        if (string.IsNullOrWhiteSpace(_searchString)) return true;
        return sp.DisplayName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
               sp.AppId.Contains(_searchString, StringComparison.OrdinalIgnoreCase);
    }

    private void ViewDetails(ServicePrincipalDto sp)
    {
        _selectedSp = sp;
        _showDialog = true;
    }

    private string GetServicePrincipalIcon(ServicePrincipalDto sp) => sp.ServicePrincipalType switch
    {
        "ManagedIdentity" => Icons.Material.Filled.Memory,
        _ => sp.IsMicrosoftFirstParty ? Icons.Material.Filled.Verified : Icons.Material.Filled.Api
    };

    private Color GetServicePrincipalColor(ServicePrincipalDto sp)
    {
        if (sp.HasHighPrivilegePermissions) return Color.Error;
        if (sp.IsMicrosoftFirstParty) return Color.Primary;
        return Color.Default;
    }

    private bool IsHighRiskPermission(string permission)
    {
        var highRisk = new[] { "Mail.ReadWrite", "Directory.ReadWrite.All", "Files.ReadWrite.All", "User.ReadWrite.All", "Application.ReadWrite.All" };
        return highRisk.Any(hr => permission.Contains(hr, StringComparison.OrdinalIgnoreCase));
    }
}
