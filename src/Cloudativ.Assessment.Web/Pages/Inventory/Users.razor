@page "/inventory/users"
@attribute [Authorize]
@using Cloudativ.Assessment.Domain.Enums
@using MudSeverity = MudBlazor.Severity
@inject IInventoryService InventoryService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>User Inventory - Cloudativ Assessment</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h5" Style="font-weight: 600; color: #51627A;">User Inventory</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">All users with MFA, risk levels, and license information</MudText>
    </div>
    <div class="d-flex gap-2 align-center">
        <MudSelect T="Guid?" Label="Tenant" Value="_selectedTenantId" Dense="true"
                   Style="min-width: 200px;" Variant="Variant.Outlined"
                   ValueChanged="@(async (Guid? val) => { _selectedTenantId = val; await OnTenantChanged(); })">
            @foreach (var tenant in _tenants)
            {
                <MudSelectItem Value="@((Guid?)tenant.Id)">@tenant.Name</MudSelectItem>
            }
        </MudSelect>
        <Cloudativ.Assessment.Web.Shared.Components.ExportDropdown
            ExportType="users"
            TenantId="_selectedTenantId"
            QueryString="@GetExportQueryString()" />
    </div>
</div>

<!-- License Distribution Chart -->
@if (_licenseDistribution.Any())
{
    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 12px;">
        <MudGrid>
            <MudItem xs="12" md="5">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #51627A;" Class="mb-3">License Distribution</MudText>
                <div style="height: 280px;">
                    <MudChart ChartType="ChartType.Donut"
                              InputData="@_chartData"
                              InputLabels="@_chartLabels"
                              Width="280px" Height="280px"
                              ChartOptions="@_chartOptions" />
                </div>
            </MudItem>
            <MudItem xs="12" md="7">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #51627A;" Class="mb-3">Users by License Type</MudText>
                <div style="max-height: 280px; overflow-y: auto;">
                    @foreach (var item in _licenseDistribution.OrderByDescending(x => x.Count))
                    {
                        <div class="d-flex align-center justify-space-between mb-2 pa-2"
                             style="border-radius: 8px; background: @(GetLicenseBackgroundColor(item.Category)); cursor: pointer;"
                             @onclick="@(() => FilterByLicense(item.Category))">
                            <div class="d-flex align-center">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: @(GetLicenseChartColor(item.Category)); margin-right: 12px;"></div>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@item.DisplayName</MudText>
                            </div>
                            <div class="d-flex align-center gap-3">
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@item.Count.ToString("N0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@item.Percentage.ToString("F1")%</MudText>
                            </div>
                        </div>
                    }
                </div>
            </MudItem>
        </MudGrid>
    </MudPaper>
}
else if (_isLoadingChart)
{
    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 12px;">
        <div class="d-flex justify-center align-center" style="height: 200px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    </MudPaper>
}

<!-- Filter Panel -->
<MudPaper Class="pa-4 mb-4" Elevation="2" Style="border-radius: 12px;">
    <MudGrid>
        <MudItem xs="12" md="3">
            <MudTextField @bind-Value="_filter.SearchTerm" Label="Search" Placeholder="Name, UPN, or email"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="LoadUsersAsync" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Label="User Type" @bind-Value="_filter.UserType" Dense="true">
                <MudSelectItem Value="@((string?)null)">All Types</MudSelectItem>
                <MudSelectItem Value="@("Member")">Member</MudSelectItem>
                <MudSelectItem Value="@("Guest")">Guest</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="MFA Status" @bind-Value="_filter.MfaEnabled" Dense="true">
                <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">MFA Enabled</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">No MFA</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Label="Risk Level" @bind-Value="_filter.RiskLevel" Dense="true">
                <MudSelectItem Value="@((string?)null)">All Risks</MudSelectItem>
                <MudSelectItem Value="@("high")">High</MudSelectItem>
                <MudSelectItem Value="@("medium")">Medium</MudSelectItem>
                <MudSelectItem Value="@("low")">Low</MudSelectItem>
                <MudSelectItem Value="@("none")">None</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="Privileged" @bind-Value="_filter.IsPrivileged" Dense="true">
                <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">Privileged Only</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Standard Users</MudSelectItem>
            </MudSelect>
        </MudItem>
    </MudGrid>
    <MudGrid Class="mt-3">
        <MudItem xs="12" md="3">
            <MudSelect T="LicenseCategory?" Label="License Type" Value="_filter.LicenseCategory" Dense="true"
                       ValueChanged="@(async (LicenseCategory? val) => { _filter.LicenseCategory = val; await LoadUsersAsync(); })">
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)null)">All Licenses</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.EnterpriseE5)">Microsoft 365 E5</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.EnterpriseE3)">Microsoft 365 E3</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.EnterpriseE1)">Microsoft 365 E1</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.BusinessPremium)">Business Premium</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.BusinessStandard)">Business Standard</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.BusinessBasic)">Business Basic</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.FrontlineF3)">Frontline F3</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.FrontlineF1)">Frontline F1</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.EducationA5)">Education A5</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.EducationA3)">Education A3</MudSelectItem>
                <MudSelectItem T="LicenseCategory?" Value="@((LicenseCategory?)LicenseCategory.EducationA1)">Education A1</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Label="Tier Group" Value="_filter.TierGroup" Dense="true"
                       ValueChanged="@(async (string val) => { _filter.TierGroup = val; await LoadUsersAsync(); })">
                <MudSelectItem Value="@((string?)null)">All Tiers</MudSelectItem>
                <MudSelectItem Value="@("Enterprise")">Enterprise</MudSelectItem>
                <MudSelectItem Value="@("Business")">Business</MudSelectItem>
                <MudSelectItem Value="@("Frontline")">Frontline</MudSelectItem>
                <MudSelectItem Value="@("Education")">Education</MudSelectItem>
                <MudSelectItem Value="@("Government")">Government</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="bool?" Label="Licensed" Value="_filter.HasAnyLicense" Dense="true"
                       ValueChanged="@(async (bool? val) => { _filter.HasAnyLicense = val; await LoadUsersAsync(); })">
                <MudSelectItem Value="@((bool?)null)">All Users</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">Licensed Only</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Unlicensed Only</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4"></MudItem>
        <MudItem xs="12" md="1" Class="d-flex align-end">
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearFilters">Clear</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<!-- Quick Stats -->
<MudGrid Class="mb-4">
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Users</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.TotalUsers.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #f44336;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">No MFA</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #f44336;">@_stats.NoMfa.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #ff9800;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">High Risk</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #ff9800;">@_stats.HighRisk.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1" Style="border-radius: 8px; border-left: 3px solid #51627A;">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Privileged</MudText>
            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_stats.Privileged.ToString("N0")</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Elevation="2" Style="border-radius: 12px;">
        <MudTable Items="_users" Dense="true" Hover="true" Striped="true"
                  ServerData="@(new Func<TableState, Task<TableData<UserInventoryDto>>>(ServerReload))"
                  @ref="_table">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortLabel="displayName" T="UserInventoryDto">User</MudTableSortLabel></MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Status</MudTh>
                <MudTh><MudTableSortLabel SortLabel="mfaEnabled" T="UserInventoryDto">MFA</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="riskLevel" T="UserInventoryDto">Risk</MudTableSortLabel></MudTh>
                <MudTh>Privileged</MudTh>
                <MudTh>Licenses</MudTh>
                <MudTh>Last Sign-In</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <div class="d-flex align-center">
                        <MudAvatar Size="Size.Small" Style="background: #E0FC8E; color: #51627A;" Class="mr-2">
                            @(context.DisplayName?.FirstOrDefault())
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.DisplayName</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.UserPrincipalName</MudText>
                        </div>
                    </div>
                </MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="@(context.UserType == "Guest" ? Color.Warning : Color.Default)" Variant="Variant.Outlined">
                        @context.UserType
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (context.AccountEnabled)
                    {
                        <MudChip Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Active</MudChip>
                    }
                    else
                    {
                        <MudChip Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">Disabled</MudChip>
                    }
                </MudTd>
                <MudTd>
                    @if (context.IsMfaRegistered)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Success" Size="Size.Small" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd>
                    <MudChip Size="Size.Small" Color="@GetRiskColor(context.RiskLevel)">
                        @(context.RiskLevel ?? "None")
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (context.IsPrivileged)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Color="Color.Warning" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd>
                    @if (!string.IsNullOrEmpty(context.PrimaryLicenseCategoryName))
                    {
                        <MudChip Size="Size.Small" Style="@GetLicenseChipStyle(context.PrimaryLicenseCategory)">
                            @context.PrimaryLicenseCategoryName
                        </MudChip>
                    }
                    else if (context.LicenseCount > 0)
                    {
                        <MudText Typo="Typo.caption">@context.LicenseCount licenses</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Unlicensed</MudText>
                    }
                </MudTd>
                <MudTd>
                    @if (context.LastSignInDateTime.HasValue)
                    {
                        <MudText Typo="Typo.body2">@context.LastSignInDateTime.Value.ToString("MMM dd, yyyy")</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Never</MudText>
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                                   OnClick="@(() => ViewUserDetails(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Class="pa-4 text-center">
                    No users found matching the current filters.
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 250 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

<!-- User Details Dialog -->
<MudDialog @bind-Visible="_showUserDialog" Options="_dialogOptions">
    <DialogContent>
        @if (_selectedUser != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <div class="d-flex align-center mb-4">
                        <MudAvatar Size="Size.Large" Style="background: #E0FC8E; color: #51627A;" Class="mr-3">
                            @(_selectedUser.DisplayName?.FirstOrDefault())
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.h6">@_selectedUser.DisplayName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedUser.UserPrincipalName</MudText>
                        </div>
                    </div>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Object ID</MudText>
                    <MudText Typo="Typo.body2">@_selectedUser.ObjectId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">User Type</MudText>
                    <MudText Typo="Typo.body2">@_selectedUser.UserType</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Account Status</MudText>
                    <MudChip Size="Size.Small" Color="@(_selectedUser.AccountEnabled ? Color.Success : Color.Error)">
                        @(_selectedUser.AccountEnabled ? "Active" : "Disabled")
                    </MudChip>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Risk Level</MudText>
                    <MudChip Size="Size.Small" Color="@GetRiskColor(_selectedUser.RiskLevel)">
                        @(_selectedUser.RiskLevel ?? "None")
                    </MudChip>
                </MudItem>
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Authentication</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">MFA Registered</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedUser.IsMfaRegistered)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> <span>Yes</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" Size="Size.Small" /> <span>No</span>
                        }
                    </MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">MFA Capable</MudText>
                    <MudText Typo="Typo.body2">
                        @if (_selectedUser.IsMfaCapable)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /> <span>Yes</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" Size="Size.Small" /> <span>No</span>
                        }
                    </MudText>
                </MudItem>
                @if (_selectedUser.IsPrivileged)
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Assigned Roles</MudText>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var role in _selectedUser.AssignedRoles)
                            {
                                <MudChip Size="Size.Small" Color="Color.Warning">@role</MudChip>
                            }
                        </div>
                    </MudItem>
                }
                @if (_selectedUser.AssignedLicenses.Any())
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Licenses</MudText>
                        @if (!string.IsNullOrEmpty(_selectedUser.PrimaryLicenseCategoryName))
                        {
                            <MudText Typo="Typo.body2" Class="mb-2">
                                <strong>Primary License:</strong>
                                <MudChip Size="Size.Small" Style="@GetLicenseChipStyle(_selectedUser.PrimaryLicenseCategory)">
                                    @_selectedUser.PrimaryLicenseCategoryName
                                </MudChip>
                            </MudText>
                        }
                        @if (_selectedUser.AllLicenseCategories.Any())
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">All License Categories:</MudText>
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                @foreach (var category in _selectedUser.AllLicenseCategories)
                                {
                                    <MudChip Size="Size.Small" Variant="Variant.Outlined">@category</MudChip>
                                }
                            </div>
                        }
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">Assigned SKUs:</MudText>
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var license in _selectedUser.AssignedLicenses)
                            {
                                <MudChip Size="Size.Small" Style="background: #E0FC8E; color: #51627A;">@license</MudChip>
                            }
                        </div>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@(() => _showUserDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [SupplyParameterFromQuery]
    public Guid? TenantId { get; set; }

    private bool _isLoading = true;
    private bool _isLoadingChart = false;
    private List<TenantDto> _tenants = new();
    private Guid? _selectedTenantId;
    private List<UserInventoryDto> _users = new();
    private MudTable<UserInventoryDto>? _table;
    private UserInventoryFilter _filter = new();
    private UserInventoryDto? _selectedUser;
    private bool _showUserDialog = false;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    private (int TotalUsers, int NoMfa, int HighRisk, int Privileged) _stats;

    // License distribution chart data
    private List<LicenseDistributionItem> _licenseDistribution = new();
    private double[] _chartData = Array.Empty<double>();
    private string[] _chartLabels = Array.Empty<string>();
    private ChartOptions _chartOptions = new()
    {
        DisableLegend = true
    };

    // License distribution item model
    private class LicenseDistributionItem
    {
        public LicenseCategory? Category { get; set; }
        public string DisplayName { get; set; } = string.Empty;
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();

        _selectedTenantId = TenantId ?? _tenants.FirstOrDefault()?.Id;
        _filter.TenantId = _selectedTenantId ?? Guid.Empty;

        if (_selectedTenantId.HasValue)
        {
            await LoadLicenseDistributionAsync();
        }

        _isLoading = false;
    }

    private async Task OnTenantChanged()
    {
        _filter.TenantId = _selectedTenantId ?? Guid.Empty;
        await LoadLicenseDistributionAsync();
        await LoadUsersAsync();
    }

    private async Task LoadLicenseDistributionAsync()
    {
        if (!_selectedTenantId.HasValue) return;

        _isLoadingChart = true;
        StateHasChanged();

        try
        {
            // Get all users with a simple filter to count by license
            var allUsersFilter = new UserInventoryFilter
            {
                TenantId = _selectedTenantId.Value,
                Page = 1,
                PageSize = 10000 // Get all for counting
            };

            var result = await InventoryService.GetUsersAsync(_selectedTenantId.Value, allUsersFilter);

            // Group users by primary license category
            var groups = result.Items
                .GroupBy(u => u.PrimaryLicenseCategory)
                .Select(g => new LicenseDistributionItem
                {
                    Category = g.Key,
                    DisplayName = GetLicenseDisplayName(g.Key),
                    Count = g.Count(),
                    Percentage = result.TotalCount > 0 ? (double)g.Count() / result.TotalCount * 100 : 0
                })
                .OrderByDescending(x => x.Count)
                .ToList();

            _licenseDistribution = groups;

            // Update chart data
            _chartData = groups.Select(x => (double)x.Count).ToArray();
            _chartLabels = groups.Select(x => x.DisplayName).ToArray();

            // Update stats
            _stats = (
                result.TotalCount,
                result.Items.Count(u => !u.IsMfaRegistered),
                result.Items.Count(u => u.RiskLevel?.ToLower() == "high"),
                result.Items.Count(u => u.IsPrivileged)
            );
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading license distribution: {ex.Message}", MudSeverity.Error);
        }
        finally
        {
            _isLoadingChart = false;
            StateHasChanged();
        }
    }

    private string GetLicenseDisplayName(LicenseCategory? category)
    {
        if (category == null) return "Unlicensed";

        return category.Value switch
        {
            LicenseCategory.EnterpriseE5 => "Microsoft 365 E5",
            LicenseCategory.EnterpriseE3 => "Microsoft 365 E3",
            LicenseCategory.EnterpriseE1 => "Microsoft 365 E1",
            LicenseCategory.BusinessPremium => "Business Premium",
            LicenseCategory.BusinessStandard => "Business Standard",
            LicenseCategory.BusinessBasic => "Business Basic",
            LicenseCategory.FrontlineF3 => "Frontline F3",
            LicenseCategory.FrontlineF1 => "Frontline F1",
            LicenseCategory.EducationA5 => "Education A5",
            LicenseCategory.EducationA3 => "Education A3",
            LicenseCategory.EducationA1 => "Education A1",
            LicenseCategory.GovernmentG5 => "Government G5",
            LicenseCategory.GovernmentG3 => "Government G3",
            LicenseCategory.GovernmentG1 => "Government G1",
            _ => category.Value.ToString()
        };
    }

    private string GetLicenseChartColor(LicenseCategory? category)
    {
        if (category == null) return "#9E9E9E"; // Gray for unlicensed

        return category.Value switch
        {
            LicenseCategory.EnterpriseE5 => "#7B1FA2",
            LicenseCategory.EnterpriseE3 => "#9C27B0",
            LicenseCategory.EnterpriseE1 => "#BA68C8",
            LicenseCategory.BusinessPremium => "#1565C0",
            LicenseCategory.BusinessStandard => "#1976D2",
            LicenseCategory.BusinessBasic => "#42A5F5",
            LicenseCategory.FrontlineF3 => "#00796B",
            LicenseCategory.FrontlineF1 => "#26A69A",
            LicenseCategory.EducationA5 => "#2E7D32",
            LicenseCategory.EducationA3 => "#388E3C",
            LicenseCategory.EducationA1 => "#66BB6A",
            LicenseCategory.GovernmentG5 => "#C62828",
            LicenseCategory.GovernmentG3 => "#D32F2F",
            LicenseCategory.GovernmentG1 => "#EF5350",
            _ => "#E0FC8E"
        };
    }

    private string GetLicenseBackgroundColor(LicenseCategory? category)
    {
        if (category == null) return "#F5F5F5";

        return category.Value switch
        {
            LicenseCategory.EnterpriseE5 or LicenseCategory.EnterpriseE3 or LicenseCategory.EnterpriseE1 => "#F3E5F5",
            LicenseCategory.BusinessPremium or LicenseCategory.BusinessStandard or LicenseCategory.BusinessBasic => "#E3F2FD",
            LicenseCategory.FrontlineF3 or LicenseCategory.FrontlineF1 => "#E0F2F1",
            LicenseCategory.EducationA5 or LicenseCategory.EducationA3 or LicenseCategory.EducationA1 => "#E8F5E9",
            LicenseCategory.GovernmentG5 or LicenseCategory.GovernmentG3 or LicenseCategory.GovernmentG1 => "#FFEBEE",
            _ => "#F9FBE7"
        };
    }

    private async Task FilterByLicense(LicenseCategory? category)
    {
        _filter.LicenseCategory = category;
        await LoadUsersAsync();
    }

    private async Task LoadTenantsAsync()
    {
        try
        {
            _tenants = (await TenantService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenants: {ex.Message}", MudSeverity.Error);
        }
    }

    private async Task LoadUsersAsync()
    {
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task<TableData<UserInventoryDto>> ServerReload(TableState state)
    {
        if (!_selectedTenantId.HasValue)
        {
            return new TableData<UserInventoryDto> { Items = new List<UserInventoryDto>(), TotalItems = 0 };
        }

        try
        {
            _filter.TenantId = _selectedTenantId.Value;
            _filter.Page = state.Page + 1;
            _filter.PageSize = state.PageSize;
            _filter.SortBy = state.SortLabel;
            _filter.SortDescending = state.SortDirection == SortDirection.Descending;

            var result = await InventoryService.GetUsersAsync(_selectedTenantId.Value, _filter);

            // Update stats based on unfiltered totals (if available) or current results
            _stats = (result.TotalCount, 0, 0, 0); // Simplified - would need separate stats endpoint

            return new TableData<UserInventoryDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", MudSeverity.Error);
            return new TableData<UserInventoryDto> { Items = new List<UserInventoryDto>(), TotalItems = 0 };
        }
    }

    private void ClearFilters()
    {
        _filter = new UserInventoryFilter { TenantId = _selectedTenantId ?? Guid.Empty };
        _table?.ReloadServerData();
    }

    private void ViewUserDetails(UserInventoryDto user)
    {
        _selectedUser = user;
        _showUserDialog = true;
    }

    private string GetExportQueryString()
    {
        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(_filter.SearchTerm)) queryParams.Add($"searchTerm={Uri.EscapeDataString(_filter.SearchTerm)}");
        if (!string.IsNullOrEmpty(_filter.UserType)) queryParams.Add($"userType={Uri.EscapeDataString(_filter.UserType)}");
        if (_filter.MfaEnabled.HasValue) queryParams.Add($"mfaEnabled={_filter.MfaEnabled.Value}");
        if (!string.IsNullOrEmpty(_filter.RiskLevel)) queryParams.Add($"riskLevel={Uri.EscapeDataString(_filter.RiskLevel)}");
        if (_filter.IsPrivileged.HasValue) queryParams.Add($"isPrivileged={_filter.IsPrivileged.Value}");
        if (_filter.LicenseCategory.HasValue) queryParams.Add($"licenseCategory={(int)_filter.LicenseCategory.Value}");
        if (!string.IsNullOrEmpty(_filter.TierGroup)) queryParams.Add($"tierGroup={Uri.EscapeDataString(_filter.TierGroup)}");
        if (_filter.HasAnyLicense.HasValue) queryParams.Add($"hasAnyLicense={_filter.HasAnyLicense.Value}");
        return string.Join("&", queryParams);
    }

    private Color GetRiskColor(string? riskLevel) => riskLevel?.ToLower() switch
    {
        "high" => Color.Error,
        "medium" => Color.Warning,
        "low" => Color.Info,
        _ => Color.Default
    };

    private string GetLicenseChipStyle(LicenseCategory? category)
    {
        if (category == null) return "background: #e0e0e0; color: #666;";

        return category.Value switch
        {
            // Enterprise - Purple shades
            LicenseCategory.EnterpriseE5 => "background: #7B1FA2; color: white;",
            LicenseCategory.EnterpriseE3 => "background: #9C27B0; color: white;",
            LicenseCategory.EnterpriseE1 => "background: #BA68C8; color: white;",

            // Business - Blue shades
            LicenseCategory.BusinessPremium => "background: #1565C0; color: white;",
            LicenseCategory.BusinessStandard => "background: #1976D2; color: white;",
            LicenseCategory.BusinessBasic => "background: #42A5F5; color: white;",

            // Frontline - Teal shades
            LicenseCategory.FrontlineF3 => "background: #00796B; color: white;",
            LicenseCategory.FrontlineF1 => "background: #26A69A; color: white;",

            // Education - Green shades
            LicenseCategory.EducationA5 => "background: #2E7D32; color: white;",
            LicenseCategory.EducationA3 => "background: #388E3C; color: white;",
            LicenseCategory.EducationA1 => "background: #66BB6A; color: white;",

            // Government - Red shades
            LicenseCategory.GovernmentG5 => "background: #C62828; color: white;",
            LicenseCategory.GovernmentG3 => "background: #D32F2F; color: white;",
            LicenseCategory.GovernmentG1 => "background: #EF5350; color: white;",

            // Add-ons - Orange/Yellow
            LicenseCategory.DefenderForEndpointP1 or LicenseCategory.DefenderForEndpointP2 or
            LicenseCategory.DefenderForOffice365P1 or LicenseCategory.DefenderForOffice365P2 or
            LicenseCategory.DefenderForIdentity or LicenseCategory.DefenderForCloudApps
                => "background: #E65100; color: white;",

            LicenseCategory.AzureADPremiumP1 or LicenseCategory.AzureADPremiumP2
                => "background: #0078D4; color: white;",

            LicenseCategory.IntuneP1 or LicenseCategory.IntuneP2
                => "background: #00A4EF; color: white;",

            // Default - Cloudativ green
            _ => "background: #E0FC8E; color: #51627A;"
        };
    }
}
